{% extends "base.html" %}
{% block title %}Umschlag 90 Tage{% endblock %}
{% block content %}

<style>
  .chart-wrap { position: relative; width: 100%; max-width: 1100px; height: 420px; margin: 0 auto; }
  .table thead th { cursor: pointer; }
  .sticky-controls { position: sticky; top: 8px; z-index: 2; }
</style>

<h3 class="mb-3">Umschlag 90 Tage</h3>

<div class="row g-3">
  <div class="col-lg-3">
    <div class="card">
      <div class="card-header py-2">Filter</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Min. Umschlag</label>
          <input id="fUmsMin" type="number" step="0.1" class="form-control" value="0">
        </div>
        <div class="mb-3">
          <label class="form-label">Max. Lagerdauer (Tage)</label>
          <input id="fLagMax" type="number" step="1" class="form-control" value="9999">
        </div>
        <div class="mb-3">
          <label class="form-label">Min. Lagerwert (€)</label>
          <input id="fLagWMin" type="number" step="0.01" class="form-control" value="0">
        </div>
        <button id="btnApply" class="btn btn-primary w-100 sticky-controls">Filtern</button>
      </div>
    </div>
  </div>

  <div class="col-lg-9">
    <div class="card mb-3">
      <div class="card-header py-2">Umschlag vs. Lagerdauer (Bubble = Lagerwert)</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header py-2">Top 15 nach Lagerwert</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header py-2">Tabelle (klickbare Sortierung)</div>
  <div class="card-body table-responsive">
    <table id="turnTable" class="table table-sm table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th data-col="produktname">Artikel</th>
          <th data-col="umschlag">Umschlag</th>
          <th data-col="lagerdauer">Lagerdauer (T)</th>
          <th data-col="lagerwert">Lagerwert (€)</th>
          <th data-col="lagerbestand">Bestand</th>
          <th data-col="vk90">Verkauf 90d (Menge)</th>
          <th data-col="cogs90">COGS 90d (€)</th>
          <th data-col="ek_min">EK min</th>
          <th data-col="ek_max">EK max</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="text-muted small">Klick auf Spaltenkopf = sortieren (↑/↓).</div>
  </div>
</div>

<script>
  // Дані з бекенду:
  const rows = {{ rows_json|safe }};   // не забудь |safe

  // Фільтри з форми (ідентифікатори як у HTML!)
  function applyFilters(data) {
    const minU  = parseFloat(document.getElementById('fUmsMin').value || 0);
    const maxL  = parseFloat(document.getElementById('fLagMax').value || 9999);
    const minLW = parseFloat(document.getElementById('fLagWMin').value || 0);
    return data.filter(d =>
      d.umschlag   >= minU &&
      d.lagerdauer <= maxL &&
      d.lagerwert  >= minLW
    );
  }

  function renderAll() {
    const data = applyFilters(rows);

    // таблиця (ID: turnTable)
    const tbody = document.querySelector('#turnTable tbody');
    tbody.innerHTML = data.map(d => `
      <tr>
        <td>${d.artikel}</td>
        <td class="text-end">${d.umschlag.toFixed(2)}</td>
        <td class="text-end">${d.lagerdauer.toFixed(1)}</td>
        <td class="text-end">${d.lagerwert.toFixed(2)}</td>
        <td class="text-end">${d.bestand}</td>
        <td class="text-end">${d.vk90.toFixed(2)}</td>
        <td class="text-end">${d.cogs90.toFixed(2)}</td>
        <td class="text-end">${d.ek_min.toFixed(2)}</td>
        <td class="text-end">${d.ek_max.toFixed(2)}</td>
      </tr>
    `).join('');

    // bubble: Umschlag vs Lagerdauer (bubble = Lagerwert)
    if (window.scChart) window.scChart.destroy();
    window.scChart = new Chart(document.getElementById('scatterChart'), {
      type: 'bubble',
      data: {
        datasets: [{
          data: data.map(d => ({ x: d.umschlag, y: d.lagerdauer, r: Math.sqrt(Math.max(d.lagerwert,0)) / 2 }))
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: 'Umschlag (90T)' } },
          y: { title: { display: true, text: 'Lagerdauer (Tage)' } }
        }
      }
    });

    // top-15 за Lagerwert
    const top = [...data].sort((a,b)=>b.lagerwert - a.lagerwert).slice(0,15);
    if (window.barChart) window.barChart.destroy();
    window.barChart = new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: { labels: top.map(d => d.artikel), datasets: [{ label: 'Lagerwert (€)', data: top.map(d => d.lagerwert) }] },
      options: { responsive: true, plugins: { legend: { display:false } } }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log('rows:', rows.length, rows.slice(0,3)); // діагностика
    renderAll();
  });
  document.getElementById('btnApply').addEventListener('click', e => { e.preventDefault(); renderAll(); });
</script>


{% endblock %}
