{# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reports_turnover.html
  Lagerumschlag-Analyse der letzten 90 Tage
  + ĞŸÑ–Ğ´ÑÑƒĞ¼ĞºĞ¸ (Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ tfoot + KPI-Ğ±ĞµĞ¹Ğ´Ğ¶Ñ–)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}

{% extends "base.html" %}
{% block title %}Umschlag 90 Tage{% endblock %}
{% block content %}

<style>
  .chart-wrap { position: relative; width: 100%; max-width: 1100px; height: 420px; margin: 0 auto; }
  .table thead th { cursor: pointer; }
  .sticky-controls { position: sticky; top: 8px; z-index: 2; }
  /* Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ¿Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ñƒ */
  #turnTable thead th { text-align: center; vertical-align: middle; }
  /* Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ */
  #turnTable thead th.sorted-asc::after  { content:" â†‘"; font-weight:600; }
  #turnTable thead th.sorted-desc::after { content:" â†“"; font-weight:600; }
</style>

<h3 class="mb-3">Umschlag 90 Tage</h3>

<div class="row g-3">
  <div class="col-lg-3">
    <div class="card">
      <div class="card-header py-2">Filter</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Min. Umschlag</label>
          <input id="fUmsMin" type="number" step="0.1" class="form-control" value="0">
        </div>
        <div class="mb-3">
          <label class="form-label">Max. Lagerdauer (Tage)</label>
          <input id="fLagMax" type="number" step="1" class="form-control" value="9999">
        </div>
        <div class="mb-3">
          <label class="form-label">Min. Lagerwert (â‚¬)</label>
          <input id="fLagWMin" type="number" step="0.01" class="form-control" value="0">
        </div>
        <button id="btnApply" class="btn btn-primary w-100 sticky-controls">Filtern</button>
      </div>
    </div>
  </div>

  <div class="col-lg-9">
    <div class="card mb-3">
      <div class="card-header py-2">Umschlag vs. Lagerdauer (Bubble = Lagerwert)</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header py-2">Top 15 nach Lagerwert</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header py-2">Tabelle (klickbare Sortierung)</div>
  <div class="card-body table-responsive">

    {# ğŸ”¹ KPI-Ğ±ĞµĞ¹Ğ´Ğ¶Ñ– (Ñ€Ğ°Ñ…ÑƒÑÑ‚ÑŒÑÑ Ğ¿Ğ¾ Ğ²Ñ–Ğ´Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ… Ñ€ÑĞ´ĞºĞ°Ñ…) #}
    <div id="kpiTotals" class="d-flex flex-wrap gap-2 mb-2 small">
      <span class="badge bg-secondary">Zeilen: <span id="kpi_rows">0</span></span>
      <span class="badge bg-secondary">Ã˜ Umschlag: <span id="kpi_ums">0,00</span></span>
      <span class="badge bg-secondary">Ã˜ Lagerdauer: <span id="kpi_lag">0,00</span> T</span>
      <span class="badge bg-secondary">âˆ‘ Lagerwert: â‚¬ <span id="kpi_lw">0,00</span></span>
      <span class="badge bg-secondary">âˆ‘ Bestand: <span id="kpi_best">0</span></span>
    </div>

    <table id="turnTable" class="table table-sm table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th data-col="artikel">Artikel</th>
          <th data-col="umschlag">Umschlag</th>
          <th data-col="lagerdauer">Lagerdauer (T)</th>
          <th data-col="lagerwert">Lagerwert (â‚¬)</th>
          <th data-col="bestand">Bestand</th>
          <th data-col="vk90">Verkauf 90d (Menge)</th>
          <th data-col="cogs90">COGS 90d (â‚¬)</th>
          <th data-col="dkost">DK (â‚¬)</th>
          <th data-col="ek_min">EK min</th>
          <th data-col="ek_max">EK max</th>
        </tr>
      </thead>
      <tbody></tbody>

      {# ğŸ”¹ ĞŸĞ†Ğ”Ğ¡Ğ£ĞœĞšĞ˜: ÑĞµÑ€ĞµĞ´Ğ½Ñ–/ÑÑƒĞ¼Ğ¸ (Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ” JS) #}
      <tfoot class="table-light">
        <tr>
          <th>Î£ / Ã˜</th>
          <th class="text-end" id="ft_umschlag_avg"></th>
          <th class="text-end" id="ft_lagerdauer_avg"></th>
          <th class="text-end" id="ft_lagerwert_sum"></th>
          <th class="text-end" id="ft_bestand_sum"></th>
          <th class="text-end" id="ft_vk90_sum"></th>
          <th class="text-end" id="ft_cogs90_sum"></th>
          <th class="text-end" id="ft_dkost_avg"></th>
          <th class="text-end" id="ft_ek_min_avg"></th>
          <th class="text-end" id="ft_ek_max_avg"></th>
        </tr>
      </tfoot>
    </table>

    <div class="text-muted small">Klick auf Spaltenkopf = sortieren (â†‘/â†“).</div>
  </div>
</div>

<script>
  // Ğ´Ğ°Ğ½Ñ– Ğ· Ğ±ĞµĞºĞµĞ½Ğ´Ğ°
  const rows = {{ rows_json|safe }};
  // Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  const nf0 = new Intl.NumberFormat('de-AT',{maximumFractionDigits:0});
  const nf2 = new Intl.NumberFormat('de-AT',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtInt  = v => nf0.format(v ?? 0);
  const fmt2    = v => nf2.format(v ?? 0);
  const fmtEuro = v => nf2.format(v ?? 0);

  // Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¸
  function applyFilters(data){
    const minU  = parseFloat(document.getElementById('fUmsMin').value || 0);
    const maxL  = parseFloat(document.getElementById('fLagMax').value || 9999);
    const minLW = parseFloat(document.getElementById('fLagWMin').value || 0);
    return data.filter(d =>
      (d.umschlag ?? 0)   >= minU &&
      (d.lagerdauer ?? 0) <= maxL &&
      (d.lagerwert ?? 0)  >= minLW
    );
  }

  // ÑĞ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  let sortCol=null, sortDir=1;
  function sortData(data){
    if(!sortCol) return data;
    return [...data].sort((a,b)=>{
      const va=a[sortCol], vb=b[sortCol];
      if(typeof va==='string' || typeof vb==='string'){
        return String(va??'').localeCompare(String(vb??''),'de')*sortDir;
      }
      return ((va??0)-(vb??0))*sortDir;
    });
  }
  function attachSorting(){
    document.querySelectorAll('#turnTable thead th').forEach(th=>{
      th.addEventListener('click',()=>{
        const col=th.dataset.col; if(!col) return;
        if(sortCol===col){ sortDir*=-1; } else { sortCol=col; sortDir=1; }
        renderAll();
        document.querySelectorAll('#turnTable thead th').forEach(h=>h.classList.remove('sorted-asc','sorted-desc'));
        th.classList.add(sortDir===1?'sorted-asc':'sorted-desc');
      });
    });
  }

  // charts
  let scChart, barChart;

  // â¬‡ï¸ Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ–Ğ´ÑÑƒĞ¼ĞºÑ–Ğ²
  const sum = (arr, key) => arr.reduce((a,x)=>a + (parseFloat(x[key])||0), 0);
  const avg = (arr, key) => arr.length ? (sum(arr,key)/arr.length) : 0;

  function renderTotals(data){
    // KPI Ğ±ĞµĞ¹Ğ´Ğ¶Ñ–
    document.getElementById('kpi_rows').textContent = fmtInt(data.length);
    document.getElementById('kpi_ums').textContent  = fmt2(avg(data,'umschlag'));
    document.getElementById('kpi_lag').textContent  = fmt2(avg(data,'lagerdauer'));
    document.getElementById('kpi_lw').textContent   = fmtEuro(sum(data,'lagerwert'));
    document.getElementById('kpi_best').textContent = fmtInt(sum(data,'bestand'));

    // Ñ„ÑƒÑ‚ĞµÑ€ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ–
    document.getElementById('ft_umschlag_avg').textContent   = fmt2(avg(data,'umschlag'));
    document.getElementById('ft_lagerdauer_avg').textContent = fmt2(avg(data,'lagerdauer'));
    document.getElementById('ft_lagerwert_sum').textContent  = fmtEuro(sum(data,'lagerwert'));
    document.getElementById('ft_bestand_sum').textContent    = fmtInt(sum(data,'bestand'));
    document.getElementById('ft_vk90_sum').textContent       = fmt2(sum(data,'vk90'));
    document.getElementById('ft_cogs90_sum').textContent     = fmtEuro(sum(data,'cogs90'));
    document.getElementById('ft_dkost_avg').textContent      = fmtEuro(avg(data,'dkost'));
    document.getElementById('ft_ek_min_avg').textContent     = fmtEuro(avg(data,'ek_min'));
    document.getElementById('ft_ek_max_avg').textContent     = fmtEuro(avg(data,'ek_max'));
  }

  function renderAll(){
    const filtered = applyFilters(rows);
    const data = sortData(filtered);

    // Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ
    const tbody = document.querySelector('#turnTable tbody');
    tbody.innerHTML = data.map(d=>`
      <tr>
        <td>${d.artikel}</td>
        <td class="text-end">${fmt2(d.umschlag)}</td>
        <td class="text-end">${fmt2(d.lagerdauer)}</td>
        <td class="text-end">${fmtEuro(d.lagerwert)}</td>
        <td class="text-end">${fmtInt(d.bestand)}</td>
        <td class="text-end">${fmt2(d.vk90)}</td>
        <td class="text-end">${fmtEuro(d.cogs90)}</td>
        <td class="text-end">${fmtEuro(d.dkost)}</td>
        <td class="text-end">${fmtEuro(d.ek_min)}</td>
        <td class="text-end">${fmtEuro(d.ek_max)}</td>
      </tr>
    `).join('');

    // Ğ¿Ñ–Ğ´ÑÑƒĞ¼ĞºĞ¸
    renderTotals(data);

    // bubble
    const minLW = Math.min(...data.map(d=>d.lagerwert ?? 0), 0);
    const maxLW = Math.max(...data.map(d=>d.lagerwert ?? 0), 1);
    const rMin=4, rMax=18;
    const rScale = v => {
      const t = (((v??0)-minLW)/((maxLW-minLW)||1));
      return rMin + t*(rMax-rMin);
    };
    const bubbleDS = data.map(d=>({x:d.umschlag??0, y:d.lagerdauer??0, r:rScale(d.lagerwert), _label:d.artikel, _lw:d.lagerwert??0}));

    if(scChart) scChart.destroy();
    scChart = new Chart(document.getElementById('scatterChart'),{
      type:'bubble',
      data:{datasets:[{data:bubbleDS}]},
      options:{
        responsive:true,
        plugins:{legend:{display:false}, tooltip:{callbacks:{label:(ctx)=> {
          const p=ctx.raw;
          return [p._label, `Umschlag: ${fmt2(p.x)}`, `Lagerdauer: ${fmt2(p.y)} T`, `Lagerwert: â‚¬ ${fmtEuro(p._lw)}`];
        }}}},
        scales:{x:{title:{display:true,text:'Umschlag (90T)'},beginAtZero:true},
                y:{title:{display:true,text:'Lagerdauer (Tage)'},beginAtZero:true}}
      }
    });

    // bar top-15
    const top = [...data].sort((a,b)=>(b.lagerwert??0)-(a.lagerwert??0)).slice(0,15);
    if(barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('barChart'),{
      type:'bar',
      data:{ labels: top.map(d=>d.artikel),
             datasets:[{label:'Lagerwert (â‚¬)', data: top.map(d=>d.lagerwert??0)}]},
      options:{ responsive:true,
        plugins:{legend:{display:false}, tooltip:{callbacks:{label:(ctx)=>`â‚¬ ${fmtEuro(ctx.parsed.y)}`}}},
        scales:{y:{beginAtZero:true, title:{display:true,text:'â‚¬'}}}
      }
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{ attachSorting(); renderAll(); });
  document.getElementById('btnApply').addEventListener('click', e=>{ e.preventDefault(); renderAll(); });
</script>

{% endblock %}
