{% extends "base.html" %}
{% block title %}Umschlag 90 Tage{% endblock %}
{% block content %}

<style>
  .chart-wrap { position: relative; width: 100%; max-width: 1100px; height: 420px; margin: 0 auto; }
  .table thead th { cursor: pointer; }
  .sticky-controls { position: sticky; top: 8px; z-index: 2; }
</style>

<h3 class="mb-3">Umschlag 90 Tage</h3>

<div class="row g-3">
  <div class="col-lg-3">
    <div class="card">
      <div class="card-header py-2">Filter</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Min. Umschlag</label>
          <input id="fUmsMin" type="number" step="0.1" class="form-control" value="0">
        </div>
        <div class="mb-3">
          <label class="form-label">Max. Lagerdauer (Tage)</label>
          <input id="fLagMax" type="number" step="1" class="form-control" value="9999">
        </div>
        <div class="mb-3">
          <label class="form-label">Min. Lagerwert (€)</label>
          <input id="fLagWMin" type="number" step="0.01" class="form-control" value="0">
        </div>
        <button id="btnApply" class="btn btn-primary w-100 sticky-controls">Filtern</button>
      </div>
    </div>
  </div>

  <div class="col-lg-9">
    <div class="card mb-3">
      <div class="card-header py-2">Umschlag vs. Lagerdauer (Bubble = Lagerwert)</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header py-2">Top 15 nach Lagerwert</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header py-2">Tabelle (klickbare Sortierung)</div>
  <div class="card-body table-responsive">
    <table id="turnTable" class="table table-sm table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th data-col="produktname">Artikel</th>
          <th data-col="umschlag">Umschlag</th>
          <th data-col="lagerdauer">Lagerdauer (T)</th>
          <th data-col="lagerwert">Lagerwert (€)</th>
          <th data-col="lagerbestand">Bestand</th>
          <th data-col="vk90">Verkauf 90d (Menge)</th>
          <th data-col="cogs90">COGS 90d (€)</th>
          <th data-col="dkost">DK (€)</th>
          <th data-col="ek_min">EK min</th>
          <th data-col="ek_max">EK max</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="text-muted small">Klick auf Spaltenkopf = sortieren (↑/↓).</div>
  </div>
</div>

<script>
  // Дані з бекенда
  const rows = {{ rows_json|safe }};
  const nf = new Intl.NumberFormat('de-AT', {maximumFractionDigits: 2});

  // ===== Фільтри =====
  function applyFilters(data) {
    const minU  = parseFloat(document.getElementById('fUmsMin').value || 0);
    const maxL  = parseFloat(document.getElementById('fLagMax').value || 9999);
    const minLW = parseFloat(document.getElementById('fLagWMin').value || 0);
    return data.filter(d =>
      d.umschlag   >= minU &&
      d.lagerdauer <= maxL &&
      d.lagerwert  >= minLW
    );
  }

  // ===== Сортування таблиці =====
  let sortCol = null;    // 'artikel' | 'umschlag' | ...
  let sortDir = 1;       // 1=ASC, -1=DESC

  function sortData(data) {
    if (!sortCol) return data;
    return [...data].sort((a,b) => {
      const va = a[sortCol], vb = b[sortCol];
      if (typeof va === 'string') return va.localeCompare(vb,'de') * sortDir;
      return (va - vb) * sortDir;
    });
  }
  function attachSorting() {
    document.querySelectorAll('#turnTable thead th').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (!col) return;
        if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = 1; }
        renderAll();
        // візуальна стрілка
        document.querySelectorAll('#turnTable thead th').forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
        th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
      });
    });
  }

  // ===== Рендер таблиці і графіків =====
  let scChart, barChart;

  function renderAll() {
    // 1) фільтр + сортування
    const filtered = applyFilters(rows);
    const data = sortData(filtered);

    // 2) таблиця
    const tbody = document.querySelector('#turnTable tbody');
    tbody.innerHTML = data.map(d => `
      <tr>
        <td>${d.artikel}</td>
        <td class="text-end">${nf.format(d.umschlag)}</td>
        <td class="text-end">${nf.format(d.lagerdauer)}</td>
        <td class="text-end">${nf.format(d.lagerwert)}</td>
        <td class="text-end">${d.bestand}</td>
        <td class="text-end">${nf.format(d.vk90)}</td>
        <td class="text-end">${nf.format(d.cogs90)}</td>
        <td class="text-end">${nf.format(d.dkost)}</td>
        <td class="text-end">${nf.format(d.ek_min)}</td>
        <td class="text-end">${nf.format(d.ek_max)}</td>
      </tr>
    `).join('');

    // 3) Bubble: Umschlag vs Lagerdauer (радіус ~ Lagerwert з нормалізацією)
    const minLW = Math.min(...data.map(d => d.lagerwert), 0);
    const maxLW = Math.max(...data.map(d => d.lagerwert), 1);
    const rMin = 4, rMax = 18;
    const rScale = v => {
      const t = (v - minLW) / (maxLW - minLW || 1);
      return rMin + t * (rMax - rMin);
    };

    const bubbleDS = data.map(d => ({
      x: d.umschlag, y: d.lagerdauer, r: rScale(d.lagerwert), _label: d.artikel,
      _lw: d.lagerwert
    }));

    if (scChart) scChart.destroy();
    scChart = new Chart(document.getElementById('scatterChart'), {
      type: 'bubble',
      data: { datasets: [{ data: bubbleDS }] },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const p = ctx.raw;
                return [
                  p._label,
                  `Umschlag: ${nf.format(p.x)}`,
                  `Lagerdauer: ${nf.format(p.y)} T`,
                  `Lagerwert: € ${nf.format(p._lw)}`
                ];
              }
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Umschlag (90T)' }, beginAtZero: true },
          y: { title: { display: true, text: 'Lagerdauer (Tage)' }, beginAtZero: true }
        }
      }
    });

    // 4) Bar: Top-15 за Lagerwert
    const top = [...data].sort((a,b)=> b.lagerwert - a.lagerwert).slice(0,15);
    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: {
        labels: top.map(d => d.artikel),
        datasets: [{ label: 'Lagerwert (€)', data: top.map(d => d.lagerwert) }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display:false }, tooltip: { callbacks: {
          label: (ctx) => `€ ${nf.format(ctx.parsed.y)}`
        }}},
        scales: { y: { beginAtZero: true, title: { display: true, text: '€' } } }
      }
    });
  }

  // init
  document.addEventListener('DOMContentLoaded', () => {
    attachSorting();
    renderAll();
  });
  document.getElementById('btnApply').addEventListener('click', e => { e.preventDefault(); renderAll(); });
</script>
<style>
  /* маленький штрих для індикатора напрямку сортування */
  #turnTable thead th.sorted-asc::after  { content:" ↑"; font-weight:600; }
  #turnTable thead th.sorted-desc::after { content:" ↓"; font-weight:600; }
</style>



{% endblock %}
