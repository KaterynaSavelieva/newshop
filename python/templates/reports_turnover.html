{# ───────────────────────────────────────────────
  reports_turnover.html
  Lagerumschlag (90 Tage)
  - Linke Spalte: Filter
  - Rechte Spalte: 2 Charts (Bubble, Bar)
  - Tabelle mit klickbarer Sortierung
  - Summenzeile unten (wird per JS aktualisiert)
─────────────────────────────────────────────── #}

{% extends "base.html" %}
{% block title %}Umschlag 90 Tage{% endblock %}
{% block content %}

<style>
  /* Breite + Höhe für Charts */
  .chart-wrap { position: relative; width: 100%; max-width: 1100px; height: 420px; margin: 0 auto; }
  /* Hand-Cursor im Tabellenkopf = man kann klicken (sortieren) */
  .table thead th { cursor: pointer; }
  /* Button bleibt oben sichtbar beim Scrollen */
  .sticky-controls { position: sticky; top: 8px; z-index: 2; }
  /* Kopfzellen hübsch ausrichten */
  #turnTable thead th { text-align: center; vertical-align: middle; }
  /* Pfeile für Sortier-Richtung */
  #turnTable thead th.sorted-asc::after  { content:" ↑"; font-weight:600; }
  #turnTable thead th.sorted-desc::after { content:" ↓"; font-weight:600; }
</style>

<h3 class="mb-3">Umschlag 90 Tage</h3>

<div class="row g-3">
  <!-- Linke Spalte: Filter-Karte -->
  <div class="col-lg-3">
    <div class="card">
      <div class="card-header py-2">Filter</div>
      <div class="card-body">
        <!-- Einfach: Minimaler Umschlag -->
        <div class="mb-3">
          <label class="form-label">Min. Umschlag</label>
          <input id="fUmsMin" type="number" step="0.1" class="form-control" value="0">
        </div>
        <!-- Einfach: Maximale Lagerdauer (in Tagen) -->
        <div class="mb-3">
          <label class="form-label">Max. Lagerdauer (Tage)</label>
          <input id="fLagMax" type="number" step="1" class="form-control" value="9999">
        </div>
        <!-- Einfach: Minimaler Lagerwert (in Euro) -->
        <div class="mb-3">
          <label class="form-label">Min. Lagerwert (€)</label>
          <input id="fLagWMin" type="number" step="0.01" class="form-control" value="0">
        </div>
        <!-- Button: Filter anwenden (ohne Reload) -->
        <button id="btnApply" class="btn btn-primary w-100 sticky-controls">Filtern</button>
      </div>
    </div>
  </div>

  <!-- Rechte Spalte: Diagramme -->
  <div class="col-lg-9">
    <!-- Bubble: Umschlag vs. Lagerdauer (Größe = Lagerwert) -->
    <div class="card mb-3">
      <div class="card-header py-2">Umschlag vs. Lagerdauer (Bubble = Lagerwert)</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="scatterChart"></canvas></div>
      </div>
    </div>

    <!-- Balken: Top 15 nach Lagerwert -->
    <div class="card mb-3">
      <div class="card-header py-2">Top 15 nach Lagerwert</div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="barChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Tabelle: klickbare Sortierung + Summen unten -->
<div class="card">
  <div class="card-header py-2">Tabelle (klickbare Sortierung)</div>
  <div class="card-body table-responsive">
    <table id="turnTable" class="table table-sm table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          {# data-col = Name des Feldes im JS-Objekt #}
          <th data-col="artikel">Artikel</th>
          <th data-col="umschlag"     class="text-end">Umschlag</th>
          <th data-col="lagerdauer"   class="text-end">Lagerdauer (T)</th>
          <th data-col="lagerwert"    class="text-end">Lagerwert (€)</th>
          <th data-col="bestand"      class="text-end">Bestand</th>
          <th data-col="vk90"         class="text-end">Verkauf 90d (Menge)</th>
          <th data-col="cogs90"       class="text-end">COGS 90d (€)</th>
          <th data-col="dkost"        class="text-end">DK (€)</th>
          <th data-col="ek_min"       class="text-end">EK min</th>
          <th data-col="ek_max"       class="text-end">EK max</th>
        </tr>
      </thead>

      <!-- Körper der Tabelle wird in JS gebaut (damit Filter/Sort live sind) -->
      <tbody></tbody>

      <!-- Summen/Ø: wird in JS befüllt, damit es zu gefilterten Daten passt -->
      <tfoot class="table-light">
        <tr>
          <th>Σ / Ø (gefiltert)</th>
          <th id="sum-umschlag"     class="text-end">–</th>
          <th id="sum-lagerdauer"   class="text-end">–</th>
          <th id="sum-lagerwert"    class="text-end">–</th>
          <th id="sum-bestand"      class="text-end">–</th>
          <th id="sum-vk90"         class="text-end">–</th>
          <th id="sum-cogs90"       class="text-end">–</th>
          <th id="sum-dkost"        class="text-end">–</th>
          <th id="sum-ekmin"        class="text-end">–</th>
          <th id="sum-ekmax"        class="text-end">–</th>
        </tr>
      </tfoot>
    </table>
    <div class="text-muted small">Klick auf Spaltenkopf = sortieren (↑/↓).</div>
  </div>
</div>

<script>
  // ─────────────────────────────────────────────
  // 1) Daten vom Backend (Python→JSON)
  //    rows_json kommt aus render_template(...)
  // ─────────────────────────────────────────────
  const rows = {{ rows_json|safe }};

  // ─────────────────────────────────────────────
  // 2) Zahlen schön formatieren
  //    'de-AT' = deutsche Formatierung in Österreich
  //    - nf0 = ganze Zahl (0 Nachkommastellen)
  //    - nf2 = 2 Nachkommastellen
  // ─────────────────────────────────────────────
  const nf0 = new Intl.NumberFormat('de-AT', { maximumFractionDigits: 0 });
  const nf1 = new Intl.NumberFormat('de-AT', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const nf2 = new Intl.NumberFormat('de-AT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const fmtInt  = v => nf0.format(v ?? 0);
  const fmt1    = v => nf1.format(v ?? 0);
  const fmt2    = v => nf2.format(v ?? 0);
  const fmtEuro = v => nf2.format(v ?? 0); // "€" steht im Header, hier nur Zahlen

  // ─────────────────────────────────────────────
  // 3) Filter anwenden
  // ─────────────────────────────────────────────
  function applyFilters(data) {
    const minU  = parseFloat(document.getElementById('fUmsMin').value || 0);
    const maxL  = parseFloat(document.getElementById('fLagMax').value || 9999);
    const minLW = parseFloat(document.getElementById('fLagWMin').value || 0);

    // Nur Zeilen behalten, die die Bedingungen erfüllen
    return data.filter(d =>
      (d.umschlag   ?? 0) >= minU &&
      (d.lagerdauer ?? 0) <= maxL &&
      (d.lagerwert  ?? 0) >= minLW
    );
  }

  // ─────────────────────────────────────────────
  // 4) Sortierung (per Klick auf Kopfzeile)
  // ─────────────────────────────────────────────
  let sortCol = null;   // z. B. 'umschlag' oder 'artikel'
  let sortDir = 1;      // 1 = aufsteigend, -1 = absteigend

  function sortData(data) {
    if (!sortCol) return data;
    return [...data].sort((a, b) => {
      const va = a[sortCol], vb = b[sortCol];
      // Strings alphabetisch, Zahlen numerisch
      if (typeof va === 'string' || typeof vb === 'string') {
        return String(va ?? '').localeCompare(String(vb ?? ''), 'de') * sortDir;
      }
      return ((va ?? 0) - (vb ?? 0)) * sortDir;
    });
  }

  function attachSorting() {
    document.querySelectorAll('#turnTable thead th').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (!col) return;
        if (sortCol === col) {
          sortDir *= -1;          // Richtung wechseln
        } else {
          sortCol = col;          // neue Spalte
          sortDir = 1;            // Start: aufsteigend
        }
        renderAll();

        // Pfeile im Kopf aktualisieren (optisch)
        document
          .querySelectorAll('#turnTable thead th')
          .forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
        th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
      });
    });
  }

  // ─────────────────────────────────────────────
  // 5) Charts-Variablen (damit wir zerstören/neu bauen können)
  // ─────────────────────────────────────────────
  let scChart, barChart;

  // ─────────────────────────────────────────────
  // 6) Summen/Averages für die Fußzeile berechnen
  //    - Summe: lagerwert, bestand, vk90, cogs90, dkost, ek_min, ek_max
  //    - Ø (Durchschnitt): umschlag, lagerdauer
  // ─────────────────────────────────────────────
  function calcTotals(data) {
    const n = data.length || 1;
    const sum = (acc, v) => acc + (v ?? 0);

    const umschlag_avg   = data.reduce((a,d)=> a + (d.umschlag   ?? 0), 0) / n;
    const lagerdauer_avg = data.reduce((a,d)=> a + (d.lagerdauer ?? 0), 0) / n;

    const lagerwert_sum  = data.reduce((a,d)=> sum(a, d.lagerwert), 0);
    const bestand_sum    = data.reduce((a,d)=> sum(a, d.bestand), 0);
    const vk90_sum       = data.reduce((a,d)=> sum(a, d.vk90), 0);
    const cogs90_sum     = data.reduce((a,d)=> sum(a, d.cogs90), 0);
    const dkost_sum      = data.reduce((a,d)=> sum(a, d.dkost), 0);
    const ekmin_sum      = data.reduce((a,d)=> sum(a, d.ek_min), 0);
    const ekmax_sum      = data.reduce((a,d)=> sum(a, d.ek_max), 0);

    return {
      umschlag_avg, lagerdauer_avg,
      lagerwert_sum, bestand_sum,
      vk90_sum, cogs90_sum,
      dkost_sum, ekmin_sum, ekmax_sum
    };
  }

  function renderTotals(t) {
    // Werte in Fußzeile schreiben (schön formatiert)
    document.getElementById('sum-umschlag'  ).textContent = fmt2(t.umschlag_avg);
    document.getElementById('sum-lagerdauer').textContent = fmt2(t.lagerdauer_avg);
    document.getElementById('sum-lagerwert' ).textContent = fmtEuro(t.lagerwert_sum);
    document.getElementById('sum-bestand'   ).textContent = fmtInt(t.bestand_sum);
    document.getElementById('sum-vk90'      ).textContent = fmtInt(t.vk90_sum);
    document.getElementById('sum-cogs90'    ).textContent = fmtEuro(t.cogs90_sum);
    document.getElementById('sum-dkost'     ).textContent = fmtEuro(t.dkost_sum);
    document.getElementById('sum-ekmin'     ).textContent = fmtEuro(t.ekmin_sum);
    document.getElementById('sum-ekmax'     ).textContent = fmtEuro(t.ekmax_sum);
  }

  // ─────────────────────────────────────────────
  // 7) Alles zeichnen: Tabelle + Charts + Summen
  // ─────────────────────────────────────────────
  function renderAll() {
    // 1) Filtern + Sortieren
    const filtered = applyFilters(rows);
    const data = sortData(filtered);

    // 2) Tabelle aufbauen (Body)
    const tbody = document.querySelector('#turnTable tbody');
    tbody.innerHTML = data.map(d => `
      <tr>
        <td>${d.artikel}</td>
        <td class="text-end">${fmt2(d.umschlag)}</td>
        <td class="text-end">${fmt2(d.lagerdauer)}</td>
        <td class="text-end">${fmtEuro(d.lagerwert)}</td>
        <td class="text-end">${fmtInt(d.bestand)}</td>
        <td class="text-end">${fmtInt(d.vk90)}</td>
        <td class="text-end">${fmtEuro(d.cogs90)}</td>
        <td class="text-end">${fmtEuro(d.dkost)}</td>
        <td class="text-end">${fmtEuro(d.ek_min)}</td>
        <td class="text-end">${fmtEuro(d.ek_max)}</td>
      </tr>
    `).join('');

    // 3) Summen/Ø berechnen und anzeigen (passt sich Filtern an)
    renderTotals(calcTotals(data));

    // 4) Bubble-Chart: Umschlag (x) vs Lagerdauer (y), Größe = Lagerwert
    const minLW = Math.min(...data.map(d => d.lagerwert ?? 0), 0);
    const maxLW = Math.max(...data.map(d => d.lagerwert ?? 0), 1);
    const rMin = 4, rMax = 18;
    const rScale = v => {
      const t = ((v ?? 0) - minLW) / ((maxLW - minLW) || 1);
      return rMin + t * (rMax - rMin);
    };
    const bubbleDS = data.map(d => ({
      x: d.umschlag ?? 0,
      y: d.lagerdauer ?? 0,
      r: rScale(d.lagerwert),
      _label: d.artikel,
      _lw: d.lagerwert ?? 0
    }));

    if (scChart) scChart.destroy();
    scChart = new Chart(document.getElementById('scatterChart'), {
      type: 'bubble',
      data: { datasets: [{ data: bubbleDS }] },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              // Schöne Tooltip-Zeilen (mit Einheiten und "€")
              label: (ctx) => {
                const p = ctx.raw;
                return [
                  p._label,
                  `Umschlag: ${fmt2(p.x)}`,
                  `Lagerdauer: ${fmt2(p.y)} T`,
                  `Lagerwert: € ${fmtEuro(p._lw)}`
                ];
              }
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Umschlag (90T)' }, beginAtZero: true },
          y: { title: { display: true, text: 'Lagerdauer (Tage)' }, beginAtZero: true }
        }
      }
    });

    // 5) Bar-Chart: Top-15 nach Lagerwert
    const top = [...data].sort((a,b)=> (b.lagerwert ?? 0) - (a.lagerwert ?? 0)).slice(0, 15);
    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('barChart'), {
      type: 'bar',
      data: {
        labels: top.map(d => d.artikel),
        datasets: [{ label: 'Lagerwert (€)', data: top.map(d => d.lagerwert ?? 0) }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display:false },
          tooltip: { callbacks: { label: (ctx) => `€ ${fmtEuro(ctx.parsed.y)}` } }
        },
        scales: { y: { beginAtZero: true, title: { display: true, text: '€' } } }
      }
    });
  }

  // ─────────────────────────────────────────────
  // 8) Init: beim Laden der Seite
  // ─────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', () => {
    attachSorting();              // Sortier-Klicks aktiv
    renderAll();                  // Erstes Zeichnen
  });

  // Filter-Button: neu rendern (mit aktuellen Werten)
  document.getElementById('btnApply').addEventListener('click', (e) => {
    e.preventDefault();
    renderAll();
  });
</script>

{% endblock %}
