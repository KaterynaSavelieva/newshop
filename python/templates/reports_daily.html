{% extends "base.html" %}
{% block title %}Umsatz pro Tag{% endblock %}

{% block content %}

<style>
    /* ‚úÖ –æ—Ö–∞–π–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ */
    .chart-wrap {
        position: relative;
        width: 100%;
        max-width: 1100px; /* –Ω–µ —Ä–æ–∑—Ç—è–≥—É–≤–∞—Ç–∏ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        height: 380px; /* —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞ –≤–∏—Å–æ—Ç–∞ */
        margin: 0 auto;
    }

    .filters .form-select[multiple] {
        height: 220px; /* –ø—Ä–∏—î–º–Ω–∞ –≤–∏—Å–æ—Ç–∞ —Å–ø–∏—Å–∫—ñ–≤ */
    }

    .filters .card {
        min-height: 270px;
    }

    .meta-line {
        font-size: .95rem;
    }
</style>

<div class="d-flex align-items-center justify-content-between mb-2">
    <h3 class="mb-0">Umsatz pro Tag</h3>
</div>

<!-- üîé –§—ñ–ª—å—Ç—Ä–∏ -->
<form class="filters" method="get" action="{{ url_for('report_daily') }}">
    <div class="row g-3 mb-3">
        <!-- –î–∞—Ç–∏ -->
        <div class="col-md-3">
            <label class="form-label">Von:</label>
            <input type="date" name="von" value="{{ von }}" class="form-control">
        </div>
        <div class="col-md-3">
            <label class="form-label">Bis:</label>
            <input type="date" name="bis" value="{{ bis }}" class="form-control">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" type="submit">Filtern</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('report_daily') }}">Zur√ºcksetzen</a>
        </div>
    </div>

    <div class="row g-3">
        <!-- ‚úÖ –ö–ª—ñ—î–Ω—Ç–∏ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kunde(n)</div>
                <div class="card-body">
                    <select name="kunden" class="form-select" multiple>
                        {# –¥–ª—è –º—É–ª—å—Ç–∏–≤–∏–±–æ—Ä—É query string –º–∞—î –∫—ñ–ª—å–∫–∞ &kunden=ID #}
                        {% for id, name in kunden_list %}
                        <option value="{{ id }}"
                                {% if kunden_sel and (id|string) in kunden_sel %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ –¢–∏–ø–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kundentyp</div>
                <div class="card-body">
                    <select name="kundentypen" class="form-select" multiple>
                        {% for id, name in kundentyp_list %}
                        <option value="{{ id }}"
                                {% if kundentyp_sel and (id|string) in kundentyp_sel %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ –ê—Ä—Ç–∏–∫—É–ª—ñ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Artikel</div>
                <div class="card-body">
                    <select name="artikel" class="form-select" multiple>
                        {% for id, name in artikel_list %}
                        <option value="{{ id }}"
                                {% if artikel_sel and (id|string) in artikel_sel %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- üßæ –†—è–¥–æ–∫ ‚Äú—â–æ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ‚Äù -->
{% set pills = [] %}
{% if von %}{% set _ = pills.append('von: ' ~ von) %}{% endif %}
{% if bis %}{% set _ = pills.append('bis: ' ~ bis) %}{% endif %}
{% if kunden_sel and kunden_sel|length > 0 %}
  {% set _ = pills.append('Kunde: ' ~ (kunden_sel|length) ~ ' ausgew√§hlt') %}
{% endif %}
{% if kundentyp_sel and kundentyp_sel|length > 0 %}
  {% set _ = pills.append('Kundentyp: ' ~ (kundentyp_sel|length) ~ ' ausgew√§hlt') %}
{% endif %}
{% if artikel_sel and artikel_sel|length > 0 %}
  {% set _ = pills.append('Artikel: ' ~ (artikel_sel|length) ~ ' ausgew√§hlt') %}
{% endif %}

{% if pills %}
<div class="alert alert-light border meta-line py-2 mt-3">
    Gefiltert:
    {% for p in pills %}
    <span class="badge bg-secondary me-1">{{ p }}</span>
    {% endfor %}
</div>
{% endif %}

<!-- üìà –ì—Ä–∞—Ñ—ñ–∫ -->
<div class="card mt-3">
    <div class="card-header py-2">Umsatz ‚Äì Diagramm (‚Ç¨/Tag & Marge %)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
</div>

<!-- üìã –¢–∞–±–ª–∏—Ü—è -->
<div class="table-responsive mt-3">
    <table class="table table-sm table-striped align-middle">
        <thead class="table-light">
            <tr>
                <th>Tag</th>
                <th>Positionen</th>
                <th>Menge</th>
                <th>Rabatt (‚Ç¨)</th>
                <th>Umsatz (‚Ç¨)</th>
                <th>Kosten (‚Ç¨)</th>
                <th>Marge (‚Ç¨)</th>
                <th>Umsatz brutto (‚Ç¨)</th>
                <th>Marge brutto (‚Ç¨)</th>
                <th>Marge (%)</th>
                <th>Marge brutto (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r[0] }}</td>
                <td>{{ r[1] }}</td>
                <td>{{ '%.0f'|format(r[2]) }}</td>
                <td>{{ '%.2f'|format(r[3]) }}</td>
                <td>{{ '%.2f'|format(r[4]) }}</td>
                <td>{{ '%.2f'|format(r[5]) }}</td>
                <td>{{ '%.2f'|format(r[6]) }}</td>
                <td>{{ '%.2f'|format(r[7]) }}</td>
                <td>{{ '%.2f'|format(r[8]) }}</td>
                <td>{{ '%.2f'|format(r[9]) }}</td>
                <td>{{ '%.2f'|format(r[10]) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-light">
            <tr>
                <th>Summe</th>
                <th>{{ totals.positionen }}</th>
                <th>{{ '%.0f'|format(totals.menge) }}</th>
                <th>{{ '%.2f'|format(totals.rabatt_eur) }}</th>
                <th>{{ '%.2f'|format(totals.umsatz) }}</th>
                <th>{{ '%.2f'|format(totals.kosten) }}</th>
                <th>{{ '%.2f'|format(totals.marge) }}</th>
                <th>{{ '%.2f'|format(totals.umsatz_br) }}</th>
                <th>{{ '%.2f'|format(totals.marge_br) }}</th>
                {# –≤—ñ–¥—Å–æ—Ç–∫–∏ –ø–æ –ø—ñ–¥—Å—É–º–∫–∞—Ö = (—Å—É–º–∞ –º–∞—Ä–∂—ñ / —Å—É–º–∞ –±–∞–∑–∏) * 100 #}
                {% set marge_pct_total = (100.0 * totals.marge / (totals.umsatz if totals.umsatz != 0 else 1.0)) %}
                {% set marge_br_pct_total = (100.0 * totals.marge_br / (totals.umsatz_br if totals.umsatz_br != 0 else 1.0)) %}
                <th>{{ '%.2f'|format(marge_pct_total) }}</th>
                <th>{{ '%.2f'|format(marge_br_pct_total) }}</th>
            </tr>
        </tfoot>
    </table>
</div>

<!-- üìä Chart.js: 1) Umsatz ‚Äì —Å—Ç–æ–≤–ø—Ü—ñ (–ª—ñ–≤–∞ –≤—ñ—Å—å ‚Ç¨), 2) Marge% ‚Äì –ª—ñ–Ω—ñ—è (–ø—Ä–∞–≤–∞ –≤—ñ—Å—å %) -->
<script>
  // –î–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ rows (—Å–µ—Ä–≤–µ—Ä –≤–∂–µ –¥–∞–≤ —Ç–∞–±–ª–∏—Ü—é)
  const labels = {{ rows|map(attribute=0)|list|tojson }};
  const umsatz = {{ rows|map(attribute=4)|list|tojson }};
  const margePct = {{ rows|map(attribute=9)|list|tojson }};  // –≤–∂–µ –æ–±—á–∏—Å–ª–µ–Ω–æ —É view v_sales_by_day

  const ctx = document.getElementById('dailyChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          type: 'bar',          // ‚úÖ —Å—Ç–æ–≤–ø—á–∏–∫–∏ ‚Äî Umsatz
          label: 'Umsatz (‚Ç¨)',
          data: umsatz,
          yAxisID: 'yEur',
          borderWidth: 1
        },
        {
          type: 'line',         // ‚úÖ –ª—ñ–Ω—ñ—è ‚Äî Marge %
          label: 'Marge (%)',
          data: margePct,
          yAxisID: 'yPct',
          borderWidth: 2,
          fill: false,
          tension: 0.25,
          pointRadius: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,   // –ø–æ–≤–∞–∂–∞—î–º–æ –≤–∏—Å–æ—Ç—É .chart-wrap
      scales: {
        yEur: {
          type: 'linear',
          position: 'left',
          title: { display: true, text: '‚Ç¨' },
          beginAtZero: true
        },
        yPct: {
          type: 'linear',
          position: 'right',
          title: { display: true, text: '%' },
          beginAtZero: true,
          grid: { drawOnChartArea: false }  // —â–æ–± —Å—ñ—Ç–∫–∞ –ø—Ä–∞–≤–æ—ó –æ—Å—ñ –Ω–µ –¥—É–±–ª—é–≤–∞–ª–∞—Å—å
        },
        x: {
          ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 14 }
        }
      },
      plugins: {
        legend: { display: true }
      }
    }
  });
</script>

{% endblock %}
