{# templates/reports_daily.html #}
{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">{{ title or "Umsatz pro Tag" }}</h2>

<!-- Filter -->
<form class="row g-3 mb-3" method="get">
    <div class="col-12 col-sm-2">
        <label class="form-label">Von:</label>
        <input type="date" class="form-control" name="von" value="{{ von }}">
    </div>
    <div class="col-12 col-sm-2">
        <label class="form-label">Bis:</label>
        <input type="date" class="form-control" name="bis" value="{{ bis }}">
    </div>
    <div class="col-12 col-sm-2">
        <label class="form-label">Detail:</label>
        <select class="form-select" name="group">
            <option value="tag" {{ 'selected' if group=='tag' }}>Tag</option>
            <option value="monat" {{ 'selected' if group=='monat' }}>Monat</option>
            <option value="jahr" {{ 'selected' if group=='jahr' }}>Jahr</option>
        </select>
    </div>

    <div class="col-12 col-md-3">
        <label class="form-label">Kunde(n):</label>
        <select multiple class="form-select" name="kunden">
            {% for kid, kname in kunden_list %}
            <option value="{{ kid }}" {{ 'selected' if kid in selected_kunden else '' }}>
                {{ kname }}
            </option>
            {% endfor %}
        </select>
        <small class="text-muted">Mehrfachauswahl mit Strg/Cmd oder Shift.</small>
    </div>

    <div class="col-12 col-md-3">
        <label class="form-label">Artikel:</label>
        <select multiple class="form-select" name="artikel">
            {% for aid, aname in artikel_list %}
            <option value="{{ aid }}" {{ 'selected' if aid in selected_artikel else '' }}>
                {{ aname }}
            </option>
            {% endfor %}
        </select>
        <small class="text-muted">Mehrfachauswahl mit Strg/Cmd oder Shift.</small>
    </div>

    <div class="col-12">
        <button class="btn btn-primary me-2" type="submit">Filtern</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('report_daily') }}">Zurücksetzen</a>
    </div>
</form>

<!-- Chart -->
<div class="card mb-4">
    <div class="card-header">Umsatz – Diagramm (€/Tag)</div>
    <div class="card-body">
        <canvas id="chart" height="110"></canvas>
    </div>
</div>

<!-- Table -->
<div class="table-responsive mb-5">
    <table id="t" class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th data-sort="str">Tag</th>
                <th class="text-end" data-sort="num">Positionen</th>
                <th class="text-end" data-sort="num">Menge</th>
                <th class="text-end" data-sort="num">Rabatt (€)</th>
                <th class="text-end" data-sort="num">Umsatz (€)</th>
                <th class="text-end" data-sort="num">Kosten (€)</th>
                <th class="text-end" data-sort="num">Marge (€)</th>
                <th class="text-end" data-sort="num">Umsatz brutto (€)</th>
                <th class="text-end" data-sort="num">Marge brutto (€)</th>
                <th class="text-end" data-sort="num">Marge (%)</th>
                <th class="text-end" data-sort="num">Marge brutto (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r[0] }}</td>
                <td class="text-end">{{ r[1] }}</td>
                <td class="text-end">{{ '%.0f'|format(r[2]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[3]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[4]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[5]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[6]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[7]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[8]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[9]) }}</td>
                <td class="text-end">{{ '%.2f'|format(r[10]) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="fw-bold">
                <td>Summe</td>
                <td class="text-end">{{ totals.positionen }}</td>
                <td class="text-end">{{ '%.0f'|format(totals.menge) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.rabatt_eur) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.umsatz) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.kosten) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.marge) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.umsatz_br) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.marge_br) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.marge_pct) }}</td>
                <td class="text-end">{{ '%.2f'|format(totals.marge_br_pct) }}</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Chart data + build -->
<script>
  const labels   = {{ rows|map(attribute=0)|list|tojson }};
  const umsatz   = {{ rows|map(attribute=4)|list|tojson }};
  const marge    = {{ rows|map(attribute=6)|list|tojson }};
  const margePct = {{ rows|map(attribute=9)|list|tojson }};

  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label: 'Umsatz (€)', data: umsatz, tension: .25},
        {label: 'Marge (€)',  data: marge,  tension: .25},
        {label: 'Marge (%)',  data: margePct, tension: .25, yAxisID: 'y2'}
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'top' } },
      scales: {
        y:  { title: { display: true, text: '€' } },
        y2: { position: 'right', title: { display: true, text: '%' }, grid: { drawOnChartArea: false } }
      }
    }
  });
</script>

<!-- Tiny table sorting -->
<script>
    (function () {
        const table = document.getElementById('t');
        const num = v => parseFloat(String(v).replace(/\s/g, '').replace(',', '.')) || 0;

        table.querySelectorAll('th').forEach((th, i) => {
            th.style.cursor = 'pointer';
            th.addEventListener('click', () => {
                const type = th.dataset.sort || 'str';
                const asc = !th.classList.contains('asc');
                table.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
                th.classList.add(asc ? 'asc' : 'desc');

                const rows = Array.from(table.tBodies[0].rows);
                rows.sort((a, b) => {
                    const A = a.cells[i].innerText.trim();
                    const B = b.cells[i].innerText.trim();
                    if (type === 'num') return (num(A) - num(B)) * (asc ? 1 : -1);
                    return A.localeCompare(B) * (asc ? 1 : -1);
                });
                rows.forEach(r => table.tBodies[0].appendChild(r));
            });
        });
    })();
</script>

{% endblock %}
