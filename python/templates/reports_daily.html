{# templates/reports_daily.html #}
{% extends "base.html" %}
{% block title %}Umsatz pro Tag{% endblock %}
{% block content %}

<style>
    .chart-wrap {
        position: relative;
        width: 100%;
        max-width: 1100px;
        height: 380px;
        margin: 0 auto;
    }

    .filters .form-select[multiple] {
        height: 220px;
    }

    .filters .card {
        min-height: 270px;
    }

    .meta-line {
        font-size: .95rem;
    }
</style>

<h3 class="mb-3">Umsatz pro {{ 'Tag' if grp=='day' else ('Monat' if grp=='month' else 'Jahr') }}</h3>

<form class="filters" method="get" action="{{ url_for('report_daily') }}">
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <label class="form-label">Von</label>
            <input class="form-control" type="date" name="von" value="{{ von }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Bis</label>
            <input class="form-control" type="date" name="bis" value="{{ bis }}">
        </div>

        <div class="col-md-4">
            <label class="form-label d-block">Intervall</label>
            <div class="btn-group" role="group">
                <input class="btn-check" type="radio" name="grp" id="g1" value="day" {% if grp= ='day' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="g1">Tag</label>
                <input class="btn-check" type="radio" name="grp" id="g2" value="month" {% if grp= ='month' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="g2">Monat</label>
                <input class="btn-check" type="radio" name="grp" id="g3" value="year" {% if grp= ='year' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="g3">Jahr</label>
            </div>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary me-2" type="submit">Filtern</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('report_daily') }}">Zurücksetzen</a>
        </div>
    </div>

    {# === 3 стовпці в один ряд: Kunde | Kundentyp | Artikel === #}
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kunde(n)</div>
                <div class="card-body">
                    <select name="kunden" class="form-select" multiple>
                        {% for id, name in kunden_list %}
                        <option value="{{ id }}" {% if kunden_sel and (id|string) in kunden_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kundentyp</div>
                <div class="card-body">
                    <select name="kundentypen" class="form-select" multiple>
                        {% for id, name in kundentyp_list %}
                        <option value="{{ id }}" {% if kundentyp_sel and (id|string) in kundentyp_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Artikel</div>
                <div class="card-body">
                    <select name="artikel" class="form-select" multiple>
                        {% for id, name in artikel_list %}
                        <option value="{{ id }}" {% if artikel_sel and (id|string) in artikel_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>
    </div>
</form>

{# === Рядок «Gefiltert» з точними назвами === #}
{% if filter_line %}
<div class="alert alert-light border meta-line py-2 mt-3">{{ filter_line|safe }}</div>
{% endif %}

<div class="card mt-3">
    <div class="card-header py-2">Umsatz – Diagramm (€/{{ grp }}) &amp; Marge (%)</div>
    <div class="card-body">
        <div class="chart-wrap">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
</div>

<div class="table-responsive mt-3">
    <table class="table table-sm table-striped table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>{{ 'Tag' if grp=='day' else ('Monat' if grp=='month' else 'Jahr') }}</th>
                <th>Positionen</th>
                <th>Menge</th>
                <th>Rabatt (€)</th>
                <th>Umsatz (€)</th>
                <th>Kosten (€)</th>
                <th>Marge (€)</th>
                <th>Umsatz brutto (€)</th>
                <th>Marge brutto (€)</th>
                <th>Marge (%)</th>
                <th>Marge brutto (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r[0] }}</td>
                <td>{{ r[1] }}</td>
                <td>{{ '%.0f'|format(r[2]) }}</td>
                <td>{{ '%.2f'|format(r[3]) }}</td>
                <td>{{ '%.2f'|format(r[4]) }}</td>
                <td>{{ '%.2f'|format(r[5]) }}</td>
                <td>{{ '%.2f'|format(r[6]) }}</td>
                <td>{{ '%.2f'|format(r[7]) }}</td>
                <td>{{ '%.2f'|format(r[8]) }}</td>
                <td>{{ '%.2f'|format(r[9]) }}</td>
                <td>{{ '%.2f'|format(r[10]) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-light">
            <tr>
                <th>Summe</th>
                <th>{{ totals.positionen }}</th>
                <th>{{ '%.0f'|format(totals.menge) }}</th>
                <th>{{ '%.2f'|format(totals.rabatt_eur) }}</th>
                <th>{{ '%.2f'|format(totals.umsatz) }}</th>
                <th>{{ '%.2f'|format(totals.kosten) }}</th>
                <th>{{ '%.2f'|format(totals.marge) }}</th>
                <th>{{ '%.2f'|format(totals.umsatz_br) }}</th>
                <th>{{ '%.2f'|format(totals.marge_br) }}</th>
                {% set marge_pct_total = (100.0 * totals.marge     / (totals.umsatz     if totals.umsatz     != 0 else 1.0)) %}
                {% set marge_br_total  = (100.0 * totals.marge_br  / (totals.umsatz_br  if totals.umsatz_br  != 0 else 1.0)) %}
                <th>{{ '%.2f'|format(marge_pct_total) }}</th>
                <th>{{ '%.2f'|format(marge_br_total) }}</th>
            </tr>
        </tfoot>
    </table>
</div>

<script>
  const labels = {{ rows|map(attribute=0)|list|tojson }};
  const umsatz = {{ rows|map(attribute=4)|list|tojson }};
  const margePct = {{ rows|map(attribute=9)|list|tojson }};

  const ctx = document.getElementById('dailyChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { type:'bar',  label:'Umsatz (€)', data: umsatz,  yAxisID:'yEur', borderWidth:1 },
        { type:'line', label:'Marge (%)',  data: margePct, yAxisID:'yPct', borderWidth:2, fill:false, tension:.25, pointRadius:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{
        yEur:{ position:'left', beginAtZero:true, title:{display:true,text:'€'} },
        yPct:{ position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, title:{display:true,text:'%'} },
        x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:14 } }
      },
      plugins:{ legend:{display:true} }
    }
  });
</script>

{% endblock %}
