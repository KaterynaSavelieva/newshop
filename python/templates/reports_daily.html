{# templates/reports_daily.html #}
{% extends "base.html" %}

{% block title %}Umsatz pro Tag{% endblock %}

{% block content %}
<h1 class="mb-3">Umsatz pro Tag</h1>

{# ─────────────────────────────────────────────────────────────
   Форма фільтрів:
   - Von/Bis (дати)
   - Kunde(n) (мультивибір)
   - Artikel (мультивибір)
   Після сабміту GET-параметри збережуться у формі (selected/values)
   ───────────────────────────────────────────────────────────── #}
<form class="card p-3 mb-4" method="get" action="{{ url_for('report_daily') }}">
  <div class="row g-3">
    <div class="col-md-2">
      <label for="von" class="form-label">Von:</label>
      <input type="date" class="form-control" id="von" name="von" value="{{ von }}">
    </div>
    <div class="col-md-2">
      <label for="bis" class="form-label">Bis:</label>
      <input type="date" class="form-control" id="bis" name="bis" value="{{ bis }}">
    </div>

    <div class="col-md-4">
      <label for="kunden" class="form-label">Kunde(n):</label>
      {# multiple — дозволяє обрати кілька; size — скільки елементів видно #}
      <select id="kunden" name="kunden" class="form-select" multiple size="6">
        {% for k in kunden %}
          {# k = (kundenID, name) #}
          <option value="{{ k[0] }}" {% if k[0] in sel_kunden %}selected{% endif %}>
            {{ k[1] }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
    </div>

    <div class="col-md-4">
      <label for="artikel" class="form-label">Artikel:</label>
      <select id="artikel" name="artikel" class="form-select" multiple size="6">
        {% for a in artikel %}
          {# a = (artikelID, produktname) #}
          <option value="{{ a[0] }}" {% if a[0] in sel_artikel %}selected{% endif %}>
            {{ a[1] }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Filtern</button>
    {# Кнопка «скинути» — просто переходить на /reports/daily без параметрів #}
    <a class="btn btn-outline-secondary" href="{{ url_for('report_daily') }}">Zurücksetzen</a>
  </div>
</form>

{# ─────────────────────────────────────────────────────────────
   Блок з графіком: дві серії — Umsatz (€) та Marge (€)
   Дані беремо з rows:
   0: tag, 4: umsatz, 6: marge
   ───────────────────────────────────────────────────────────── #}
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Umsatz – Diagramm (€/Tag)</h5>
    <canvas id="chartUmsatz" height="100"></canvas>
  </div>
</div>

{# ─────────────────────────────────────────────────────────────
   Таблиця з підсумками за днями.
   Імена колонок — німецькою.
   Індекси полів у rows:
   0 tag | 1 positionen | 2 menge | 3 rabatt_eur | 4 umsatz
   5 kosten | 6 marge | 7 umsatz_brutto | 8 marge_brutto
   9 marge_prozent | 10 marge_brutto_prozent
   ───────────────────────────────────────────────────────────── #}
<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>Tag</th>
        <th>Positionen</th>
        <th>Menge</th>
        <th>Rabatt (€)</th>
        <th>Umsatz (€)</th>
        <th>Kosten (€)</th>
        <th>Marge (€)</th>
        <th>Umsatz brutto (€)</th>
        <th>Marge brutto (€)</th>
        <th>Marge (%)</th>
        <th>Marge brutto (%)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r[0] }}</td>
        <td class="text-end">{{ r[1] }}</td>
        <td class="text-end">{{ "%.0f"|format(r[2]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[3]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[4]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[5]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[6]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[7]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[8]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[9]) }}</td>
        <td class="text-end">{{ "%.2f"|format(r[10]) }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot class="table-light">
      <tr>
        <th>Summe</th>
        <th class="text-end">{{ totals.positionen }}</th>
        <th class="text-end">{{ "%.0f"|format(totals.menge) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.rabatt_eur) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.umsatz) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.kosten) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.marge) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.umsatz_br) }}</th>
        <th class="text-end">{{ "%.2f"|format(totals.marge_br) }}</th>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
  </table>
</div>

{# ─────────────────────────────────────────────────────────────
   Підключення Chart.js (CDN) і побудова лінійного графіка.
   Якщо у твоєму base.html вже є Chart.js — цей <script> можна прибрати.
   ───────────────────────────────────────────────────────────── #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Дані для графіка беремо з Jinja-перемінних (rows)
  // Створюємо масиви ярликів (дні) та значень Umsatz/Marge
  const labels = [{% for r in rows %}"{{ r[0] }}"{% if not loop.last %},{% endif %}{% endfor %}];
  const umsatz = [{% for r in rows %}{{ "%.2f"|format(r[4]) }}{% if not loop.last %},{% endif %}{% endfor %}];
  const marge  = [{% for r in rows %}{{ "%.2f"|format(r[6]) }}{% if not loop.last %},{% endif %}{% endfor %}];

  const ctx = document.getElementById('chartUmsatz').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Umsatz (€)',
          data: umsatz,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 2
        },
        {
          label: 'Marge (€)',
          data: marge,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 2
        }
      ]
    },
    options: {
      plugins: {
        legend: { display: true },
        tooltip: { mode: 'index', intersect: false }
      },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { ticks: { maxRotation: 0, autoSkip: true } },
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endblock %}
