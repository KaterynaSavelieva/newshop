{# ───────────────────────────────────────────────
  reports_daily.html
  Zeigt Umsatz/Marge nach Zeitintervall (Tag/Monat/Jahr)
  Mit Filter, Chart und Tabelle
─────────────────────────────────────────────── #}
{% extends "base.html" %}
{% block title %}Umsatz pro Tag{% endblock %}
{% block content %}

<style>
  /*  Seiten-Stile (nur für diese Seite) */
  .chart-wrap{position:relative;width:100%;max-width:1100px;height:380px;margin:0 auto}
  .filters .form-select[multiple]{height:220px}
  .filters .card{min-height:270px}
  .meta-line{font-size:.95rem}
  .action-bar{position:sticky;top:8px;z-index:2}
</style>

<!--  Überschrift -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <h3 class="mb-0">Umsatz pro Tag</h3>
</div>

{# Filterformular: Zeitraum + Intervall + Mehrfachfilter #}
<form class="filters" method="get" action="{{ url_for('reports.report_daily') }}">
  <div class="row g-3 mb-3">
    <!-- Datum von/bis -->
    <div class="col-md-3">
      <label class="form-label">Von:</label>
      <input type="date" name="von" value="{{ von }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Bis:</label>
      <input type="date" name="bis" value="{{ bis }}" class="form-control">
    </div>

    <!--  Intervallauswahl (Tag / Monat / Jahr) -->
    <div class="col-md-4">
      <label class="form-label d-block">Intervall</label>
      <div class="btn-group" role="group">
        <input class="btn-check" type="radio" name="grp" id="g1" value="day"   {{ 'checked' if grp=='day'   else '' }}>
        <label class="btn btn-outline-primary" for="g1">Tag</label>

        <input class="btn-check" type="radio" name="grp" id="g2" value="month" {{ 'checked' if grp=='month' else '' }}>
        <label class="btn btn-outline-primary" for="g2">Monat</label>

        <input class="btn-check" type="radio" name="grp" id="g3" value="year"  {{ 'checked' if grp=='year'  else '' }}>
        <label class="btn btn-outline-primary" for="g3">Jahr</label>
      </div>
    </div>

    <!--  Aktionen -->
    <div class="col-md-2 d-flex align-items-end justify-content-end gap-2 action-bar">
      <button class="btn btn-primary" type="submit">Filtern</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('reports.report_daily') }}">Zurücksetzen</a>
    </div>
  </div>

  <div class="row g-3">
    <!-- Kunde(n) -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header py-2">Kunde(n)</div>
        <div class="card-body">
          <select name="kunden" class="form-select" multiple>
            {% for id, name in kunden_list %}
              <option value="{{ id }}" {% if kunden_sel and (id|string) in kunden_sel %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
        </div>
      </div>
    </div>

    <!--  Kundentyp -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header py-2">Kundentyp</div>
        <div class="card-body">
          <select name="kundentypen" class="form-select" multiple>
            {% for id, name in kundentyp_list %}
              <option value="{{ id }}" {% if kundentyp_sel and (id|string) in kundentyp_sel %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
        </div>
      </div>
    </div>

    <!-- Artikel -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header py-2">Artikel</div>
        <div class="card-body">
          <select name="artikel" class="form-select" multiple>
            {% for id, name in artikel_list %}
              <option value="{{ id }}" {% if artikel_sel and (id|string) in artikel_sel %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
        </div>
      </div>
    </div>
  </div>
</form>

{#  Kompakte Anzeige: Welche Filter sind aktiv? #}
{% set pills = [] %}
{% if von %}{% set _ = pills.append('von: ' ~ von) %}{% endif %}
{% if bis %}{% set _ = pills.append('bis: ' ~ bis) %}{% endif %}
{% if grp %}{% set _ = pills.append('Intervall: ' ~ grp) %}{% endif %}

{# Namen statt IDs anzeigen (Kunden) #}
{% if kunden_sel and kunden_sel|length > 0 %}
  {% set names = [] %}
  {% for id, name in kunden_list %}
    {% if (id|string) in kunden_sel %}{% set _ = names.append(name) %}{% endif %}
  {% endfor %}
  {% set _ = pills.append('Kunde: ' ~ (names|join(', '))) %}
{% endif %}

{# Namen statt IDs anzeigen (Kundentyp) #}
{% if kundentyp_sel and kundentyp_sel|length > 0 %}
  {% set names = [] %}
  {% for id, name in kundentyp_list %}
    {% if (id|string) in kundentyp_sel %}{% set _ = names.append(name) %}{% endif %}
  {% endfor %}
  {% set _ = pills.append('Kundentyp: ' ~ (names|join(', '))) %}
{% endif %}

{# Namen statt IDs anzeigen (Artikel) #}
{% if artikel_sel and artikel_sel|length > 0 %}
  {% set names = [] %}
  {% for id, name in artikel_list %}
    {% if (id|string) in artikel_sel %}{% set _ = names.append(name) %}{% endif %}
  {% endfor %}
  {% set _ = pills.append('Artikel: ' ~ (names|join(', '))) %}
{% endif %}

{% if pills %}
  <div class="alert alert-light border meta-line py-2 mt-3">
    Gefiltert:
    {% for p in pills %}<span class="badge bg-secondary me-1">{{ p }}</span>{% endfor %}
  </div>
{% endif %}

<!--  Diagramm: Umsatz/Marge in € (Balken) + Marge % (Linie) -->
<div class="card mt-3">
  <div class="card-header py-2">
    Umsatz – Diagramm (€/{{ 'day' if grp=='day' else ('month' if grp=='month' else ('year' if grp=='year' else 'day')) }}) &amp; Marge (%)
  </div>
  <div class="card-body">
    <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
  </div>
</div>

<!-- Tabelle mit Werten (Format wie in customers: |thousands ) -->
<div class="table-responsive mt-3">
  <table class="table table-sm table-striped table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Tag/Label</th>
        <th>Positionen</th>
        <th>Menge</th>
        <th>Rabatt (€)</th>
        <th>Umsatz (€)</th>
        <th>Kosten (€)</th>
        <th>Marge (€)</th>
        <th>Umsatz brutto (€)</th>
        <th>Marge brutto (€)</th>
        <th>Marge (%)</th>
        <th>Marge brutto (%)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r[0] }}</td>                              {# Label: Tag/Monat/Jahr #}
        <td class="text-end">{{ r[1] | thousands(0) }}</td>
        <td class="text-end">{{ r[2] | thousands(0) }}</td>
        <td class="text-end">{{ r[3] | thousands }}</td>
        <td class="text-end">{{ r[4] | thousands }}</td>
        <td class="text-end">{{ r[5] | thousands }}</td>
        <td class="text-end">{{ r[6] | thousands }}</td>
        <td class="text-end">{{ r[7] | thousands }}</td>
        <td class="text-end">{{ r[8] | thousands }}</td>
        <td class="text-end">{{ r[9]  | thousands(2) }} %</td>
        <td class="text-end">{{ r[10] | thousands(2) }} %</td>
      </tr>
      {% endfor %}
    </tbody>

    {#  Fußzeile: Gesamtsummen (mit thousands) #}
    <tfoot class="table-light">
      <tr>
        <th>Summe</th>
        <th class="text-end">{{ totals.positionen | thousands(0) }}</th>
        <th class="text-end">{{ totals.menge      | thousands(0) }}</th>
        <th class="text-end">{{ totals.rabatt_eur | thousands    }}</th>
        <th class="text-end">{{ totals.umsatz     | thousands    }}</th>
        <th class="text-end">{{ totals.kosten     | thousands    }}</th>
        <th class="text-end">{{ totals.marge      | thousands    }}</th>
        <th class="text-end">{{ totals.umsatz_br  | thousands    }}</th>
        <th class="text-end">{{ totals.marge_br   | thousands    }}</th>
        {% set marge_pct_total    = (100.0 * totals.marge    / (totals.umsatz    if totals.umsatz    != 0 else 1.0)) %}
        {% set marge_br_pct_total = (100.0 * totals.marge_br / (totals.umsatz_br if totals.umsatz_br != 0 else 1.0)) %}
        <th class="text-end">{{ marge_pct_total    | thousands(2) }} %</th>
        <th class="text-end">{{ marge_br_pct_total | thousands(2) }} %</th>
      </tr>
    </tfoot>
  </table>
</div>

<script>
  //  Daten aus Python → JavaScript (für Chart.js)
  const labels    = {{ rows|map(attribute=0)|list|tojson }}; // X-Achse: Tag/Monat/Jahr
  const umsatz    = {{ rows|map(attribute=4)|list|tojson }}; // €
  const margeEuro = {{ rows|map(attribute=6)|list|tojson }}; // €
  const margePct  = {{ rows|map(attribute=9)|list|tojson }}; // %

  // Kombi-Chart: Balken (€/€) + Linie (%)
  new Chart(document.getElementById('dailyChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { type:'bar',  label:'Umsatz (€)', data: umsatz,    yAxisID:'yEur', borderWidth:1 },
        { type:'bar',  label:'Marge (€)',  data: margeEuro, yAxisID:'yEur', borderWidth:1 },
        { type:'line', label:'Marge (%)',  data: margePct,  yAxisID:'yPct', borderWidth:2, fill:false, tension:.25, pointRadius:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{
        yEur:{ type:'linear', position:'left',  title:{display:true,text:'€'}, beginAtZero:true },
        yPct:{ type:'linear', position:'right', title:{display:true,text:'%'}, beginAtZero:true, grid:{drawOnChartArea:false} },
        x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:14 } }
      },
      plugins:{ legend:{ display:true } }
    }
  });
</script>

{% endblock %}
