{# templates/reports_daily.html #}
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>{{ title }}</h3>
  <form class="d-flex gap-2" method="get">
    <!-- Zeitraum-Auswahl -->
    <input type="date" name="von" value="{{ von }}" class="form-control form-control-sm">
    <input type="date" name="bis" value="{{ bis }}" class="form-control form-control-sm">

    <!-- Gruppierung: Tag / Monat / Jahr -->
    <select name="grp" class="form-select form-select-sm">
      <option value="day"   {% if grp =='day' %}selected{% endif %}>Tag</option>
      <option value="month" {% if grp =='month' %}selected{% endif %}>Monat</option>
      <option value="year"  {% if grp =='year' %}selected{% endif %}>Jahr</option>
    </select>

    <!-- Kundenfilter -->
    <select name="kunden" class="form-select form-select-sm" multiple>
      {% for k in kunden_list %}
        <option value="{{ k[0] }}" {% if k[0]|string in kunden_sel %}selected{% endif %}>
          {{ k[1] }}
        </option>
      {% endfor %}
    </select>

    <!-- Artikel-Filter -->
    <select name="artikel" class="form-select form-select-sm" multiple>
      {% for a in artikel_list %}
        <option value="{{ a[0] }}" {% if a[0]|string in artikel_sel %}selected{% endif %}>
          {{ a[1] }}
        </option>
      {% endfor %}
    </select>

    <!-- Kundentyp-Filter -->
    <select name="kundentypen" class="form-select form-select-sm" multiple>
      {% for t in kundentyp_list %}
        <option value="{{ t[0] }}" {% if t[0]|string in kundentyp_sel %}selected{% endif %}>
          {{ t[1] }}
        </option>
      {% endfor %}
    </select>

    <button class="btn btn-primary btn-sm">Aktualisieren</button>
  </form>
</div>

<!-- Zeile mit gewählten Filtern -->
<p class="text-muted small">{{ filter_line }}</p>

<!-- Diagramm (Umsatz und Marge%) -->
<div class="card mb-4">
  <div class="card-body">
    <canvas id="chartUmsatz"></canvas>
  </div>
</div>

<!-- Tabelle mit allen Daten -->
<div class="card">
  <div class="card-body p-0">
    <table class="table table-hover table-sm mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Datum</th>
          <th class="text-end">Positionen</th>
          <th class="text-end">Menge</th>
          <th class="text-end">Rabatt (€)</th>
          <th class="text-end">Umsatz (€)</th>
          <th class="text-end">Kosten (€)</th>
          <th class="text-end">Marge (€)</th>
          <th class="text-end">Marge (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r[0] }}</td>
          <td class="text-end">{{ r[1] }}</td>
          <td class="text-end">{{ "%.0f"|format(r[2]) }}</td>
          <td class="text-end">{{ "%.2f"|format(r[3]) }}</td>
          <td class="text-end fw-semibold text-success">{{ "%.2f"|format(r[4]) }}</td>
          <td class="text-end">{{ "%.2f"|format(r[5]) }}</td>
          <td class="text-end text-primary">{{ "%.2f"|format(r[6]) }}</td>
          <td class="text-end">{{ "%.1f"|format(r[9]) }}%</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light fw-semibold">
        <tr>
          <td>Gesamt</td>
          <td class="text-end">{{ totals.positionen }}</td>
          <td class="text-end">{{ "%.0f"|format(totals.menge) }}</td>
          <td class="text-end">{{ "%.2f"|format(totals.rabatt_eur) }}</td>
          <td class="text-end text-success">{{ "%.2f"|format(totals.umsatz) }}</td>
          <td class="text-end">{{ "%.2f"|format(totals.kosten) }}</td>
          <td class="text-end text-primary">{{ "%.2f"|format(totals.marge) }}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Chart.js Script -->
<script>
  const ctx = document.getElementById("chartUmsatz");
  const data = {
    labels: {{ rows|map(attribute=0)|list|tojson }},
    datasets: [
      {
        label: "Umsatz (€)",
        data: {{ rows|map(attribute=4)|list|tojson }},
        type: "bar",
        yAxisID: "y1",
        borderWidth: 1,
        backgroundColor: "rgba(54, 162, 235, 0.6)"
      },
      {
        label: "Marge (%)",
        data: {{ rows|map(attribute=9)|list|tojson }},
        type: "line",
        yAxisID: "y2",
        borderColor: "rgba(255, 99, 132, 1)",
        tension: 0.3
      }
    ]
  };
  new Chart(ctx, {
    data,
    options: {
      responsive: true,
      scales: {
        y1: {
          type: "linear",
          position: "left",
          title: { display: true, text: "Umsatz (€)" }
        },
        y2: {
          type: "linear",
          position: "right",
          title: { display: true, text: "Marge (%)" },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
</script>
{% endblock %}
