{% extends "base.html" %}
{% block title %}Umsatz pro Tag{% endblock %}

{% block content %}
<div class="container-xxl py-4">

    <!-- Заголовок сторінки -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 mb-0">Umsatz pro Tag</h1>
        <div class="small text-muted">Bericht · Zeitraum &amp; Mehrfachfilter</div>
    </div>

    <!-- Форма фільтрів -->
    <form class="card shadow-sm mb-4" method="get">
        <div class="card-body">
            <!-- Сітка фільтрів -->
            <div class="row g-3 align-items-end">
                <!-- Діапазон дат -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Von:</label>
                    <input type="date" name="von" value="{{ von or '' }}" class="form-control">
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Bis:</label>
                    <input type="date" name="bis" value="{{ bis or '' }}" class="form-control">
                </div>

                <!-- Групування (Tag/Monat/Jahr) -->
                <div class="col-12 col-md-2">
                    <label class="form-label">Detail:</label>
                    <select name="group" class="form-select">
                        <option value="tag" {{ 'selected' if (group or 'tag')=='tag'   else '' }}>Tag</option>
                        <option value="monat" {{ 'selected' if group=='monat' else '' }}>Monat</option>
                        <option value="jahr" {{ 'selected' if group=='jahr'  else '' }}>Jahr</option>
                    </select>
                </div>

                <!-- Клієнти (multi-select) -->
                <div class="col-12 col-lg-4">
                    <label class="form-label">Kunde(n):</label>
                    <!-- підказка: Ctrl/Cmd або Shift для множинного вибору -->
                    <select name="kunden" class="form-select" multiple size="5">
                        {% for kid, kname in (kunden_list or []) %}
                        <option value="{{ kid }}" {% if sel_kunden and kid in sel_kunden %}selected{% endif %}>
                            {{ kname }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>

                <!-- Артиклі (multi-select) -->
                <div class="col-12 col-lg-4">
                    <label class="form-label">Artikel:</label>
                    <select name="artikel" class="form-select" multiple size="5">
                        {% for aid, aname in (artikel_list or []) %}
                        <option value="{{ aid }}" {% if sel_artikel and aid in sel_artikel %}selected{% endif %}>
                            {{ aname }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>

                <!-- Кнопки -->
                <div class="col-12 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        Filtern
                    </button>
                    <a class="btn btn-outline-secondary" href="{{ url_for('report_daily') }}">
                        Zurücksetzen
                    </a>
                </div>
            </div>

            <!-- Рядок-пояснення застосованих фільтрів -->
            <div class="mt-3 small text-muted">
                {% set grp_label = {'tag':'Tag','monat':'Monat','jahr':'Jahr'}[(group or 'tag')] %}
                Gefiltert:
                Zeitraum <strong>{{ von }}</strong> bis <strong>{{ bis }}</strong>;
                Detail: <strong>{{ grp_label }}</strong>;
                {% if sel_kunden and kunden_list %}
                Kunden:
                <strong>
                    {% set names = [] %}
                    {% for kid, kname in kunden_list %}
                    {% if kid in sel_kunden %}{% set _ = names.append(kname) %}{% endif %}
                    {% endfor %}
                    {{ names|join(', ') if names else 'Alle' }}
                </strong>;
                {% else %}
                Kunden: <strong>Alle</strong>;
                {% endif %}
                {% if sel_artikel and artikel_list %}
                Artikel:
                <strong>
                    {% set anames = [] %}
                    {% for aid, aname in artikel_list %}
                    {% if aid in sel_artikel %}{% set _ = anames.append(aname) %}{% endif %}
                    {% endfor %}
                    {{ anames|join(', ') if anames else 'Alle' }}
                </strong>.
                {% else %}
                Artikel: <strong>Alle</strong>.
                {% endif %}
            </div>
        </div>
    </form>

    <!-- Карта з графіком -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="h6 mb-3">Umsatz – Diagramm (€/Tag)</h2>
            <canvas id="dailyChart" height="110"></canvas>
            <div class="form-text">
                Balken: Umsatz (€), Linie: Marge (%). Linke Y-Achse in € · rechte Y-Achse in %.
            </div>
        </div>
    </div>

    <!-- Таблиця результатів -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Tag</th>
                            <th class="text-end">Positionen</th>
                            <th class="text-end">Menge</th>
                            <th class="text-end">Rabatt (€)</th>
                            <th class="text-end">Umsatz (€)</th>
                            <th class="text-end">Kosten (€)</th>
                            <th class="text-end">Marge (€)</th>
                            <th class="text-end">Umsatz brutto (€)</th>
                            <th class="text-end">Marge brutto (€)</th>
                            <th class="text-end">Marge (%)</th>
                            <th class="text-end">Marge brutto (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr>
                            <td>{{ r[0] }}</td>
                            <td class="text-end">{{ r[1] }}</td>
                            <td class="text-end">{{ r[2]|round(2) }}</td>
                            <td class="text-end">{{ r[3]|round(2) }}</td>
                            <td class="text-end">{{ r[4]|round(2) }}</td>
                            <td class="text-end">{{ r[5]|round(2) }}</td>
                            <td class="text-end">{{ r[6]|round(2) }}</td>
                            <td class="text-end">{{ r[7]|round(2) }}</td>
                            <td class="text-end">{{ r[8]|round(2) }}</td>
                            <td class="text-end">{{ r[9]|round(2) }}</td>
                            <td class="text-end">{{ r[10]|round(2) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th>Summe</th>
                            <th class="text-end">{{ totals.positionen or 0 }}</th>
                            <th class="text-end">{{ (totals.menge or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.rabatt_eur or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.umsatz or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.kosten or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.marge or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.umsatz_br or 0)|round(2) }}</th>
                            <th class="text-end">{{ (totals.marge_br or 0)|round(2) }}</th>
                            <!-- % обчислюємо прямо в шаблоні -->
                            <th class="text-end">
                                {{ ((totals.marge or 0) / (totals.umsatz or 1) * 100)|round(2) }}
                            </th>
                            <th class="text-end">
                                {{ ((totals.marge_br or 0) / (totals.umsatz_br or 1) * 100)|round(2) }}
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js: побудова комбінованого графіка (бар + лінія з другою віссю) -->
<script>
  // Дані для графіку беремо з rows
  const labels = [
    {% for r in rows %}"{{ r[0] }}"{% if not loop.last %},{% endif %}{% endfor %}
  ];
  const dataUmsatz = [
    {% for r in rows %}{{ (r[4] or 0)|round(2) }}{% if not loop.last %},{% endif %}{% endfor %}
  ];
  const dataMargePct = [
    {% for r in rows %}{{ (r[9] or 0)|round(2) }}{% if not loop.last %},{% endif %}{% endfor %}
  ];

  const ctx = document.getElementById('dailyChart').getContext('2d');
  // Створюємо комбінований графік: бари (Umsatz) + лінія (Marge %)
  const dailyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          type: 'bar',
          label: 'Umsatz (€)',
          data: dataUmsatz,
          borderWidth: 1,
          yAxisID: 'yEuro'
        },
        {
          type: 'line',
          label: 'Marge (%)',
          data: dataMargePct,
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 2,
          yAxisID: 'yPct'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        // Ліва вісь — євро
        yEuro: {
          type: 'linear',
          position: 'left',
          ticks: {
            // формат підписів по осі €
            callback: (v) => '€ ' + v
          }
        },
        // Права вісь — відсотки
        yPct: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          ticks: {
            callback: (v) => v + ' %'
          }
        },
        x: {
          ticks: { maxRotation: 0, autoSkip: true }
        }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            // гарні підказки для різних осей
            label: function(ctx) {
              const ds = ctx.dataset.label || '';
              const v  = ctx.parsed.y;
              if (ctx.dataset.yAxisID === 'yPct') return `${ds}: ${v.toFixed(2)} %`;
              return `${ds}: € ${v.toFixed(2)}`;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
