{% extends "base.html" %}
{% block title %}Umsatz pro Artikel{% endblock %}
{% block content %}

<style>
    .chart-wrap {
        position: relative;
        width: 100%;
        max-width: 1100px;
        height: 420px;
        margin: 0 auto;
    }

    .filters .form-select[multiple] {
        height: 220px;
    }

    .filters .card {
        min-height: 270px;
    }

    .action-bar {
        position: sticky;
        top: 8px;
        z-index: 2;
    }
</style>

<h3 class="mb-3">Umsatz pro Artikel{% if grp!='items' %} – {{ 'Tag' if grp=='day' else ('Monat' if grp=='month' else 'Jahr') }}{% endif %}</h3>

<form class="filters" method="get" action="{{ url_for('reports.report_articles') }}">
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <label class="form-label">Von</label>
            <input class="form-control" type="date" name="von" value="{{ von }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Bis</label>
            <input class="form-control" type="date" name="bis" value="{{ bis }}">
        </div>
        <div class="col-md-2">
            <label class="form-label">Top N</label>
            <input class="form-control" type="number" name="top" min="5" max="100" value="{{ top_n }}">
        </div>

        <div class="col-md-4">
            <label class="form-label d-block">Intervall</label>
            <div class="btn-group" role="group">
                <input class="btn-check" type="radio" name="grp" id="ga" value="items" {{ 'checked' if grp == 'items' else '' }}>
                <label class="btn btn-outline-primary" for="ga">Artikel (Top N)</label>

                <input class="btn-check" type="radio" name="grp" id="g1" value="day" {{ 'checked' if grp == 'day' else '' }}>
                <label class="btn btn-outline-primary" for="g1">Tag</label>

                <input class="btn-check" type="radio" name="grp" id="g2" value="month" {{ 'checked' if grp == 'month' else '' }}>
                <label class="btn btn-outline-primary" for="g2">Monat</label>

                <input class="btn-check" type="radio" name="grp" id="g3" value="year" {{ 'checked' if grp == 'year' else '' }}>
                <label class="btn btn-outline-primary" for="g3">Jahr</label>
            </div>
        </div>

        <div class="col-md-2 d-flex align-items-end justify-content-end gap-2 action-bar">
            <button class="btn btn-primary" type="submit">Filtern</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('reports.report_articles') }}">Zurücksetzen</a>
        </div>
    </div>

    <!-- ТРИ селекти -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Artikel</div>
                <div class="card-body">
                    <select name="artikel" class="form-select" multiple>
                        {% for id,name in artikel_list %}
                        <option value="{{ id }}" {% if artikel_sel and (id|string) in artikel_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kunde(n)</div>
                <div class="card-body">
                    <select name="kunden" class="form-select" multiple>
                        {% for id,name in kunden_list %}
                        <option value="{{ id }}" {% if kunden_sel and (id|string) in kunden_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">Kundentyp</div>
                <div class="card-body">
                    <select name="kundentypen" class="form-select" multiple>
                        {% for id,name in kundentyp_list %}
                        <option value="{{ id }}" {% if kundentyp_sel and (id|string) in kundentyp_sel %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Mehrfachauswahl mit Strg/Cmd oder Shift.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Filtern</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('reports.report_articles') }}">Zurücksetzen</a>
    </div>
</form>

{% if filter_line %}
<div class="alert alert-light border py-2 mt-3">{{ filter_line|safe }}</div>
{% endif %}

{% if ts_mode_msg %}
<div class="alert alert-warning py-2 mt-3">{{ ts_mode_msg }}</div>
{% endif %}

<div class="card mt-3">
    <div class="card-header py-2">Umsatz – Balken &amp; Marge (%) – Linie</div>
    <div class="card-body">
        <div class="chart-wrap"><canvas id="artChart"></canvas></div>
    </div>
</div>

<div class="table-responsive mt-3">
    <table class="table table-sm table-striped table-bordered align-middle">
        <thead class="table-light">
            {% if grp == 'items' %}
            <tr>
                <th>#</th>
                <th>Artikel</th>
                <th>Positionen</th>
                <th>Menge</th>
                <th>Umsatz (€)</th>
                <th>Kosten (€)</th>
                <th>Marge (€)</th>
                <th>Marge (%)</th>
            </tr>
            {% else %}
            <tr>
                <th>#</th>
                <th>{{ 'Tag' if grp=='day' else ('Monat' if grp=='month' else 'Jahr') }}</th>
                <th>Positionen</th>
                <th>Menge</th>
                <th>Umsatz (€)</th>
                <th>Kosten (€)</th>
                <th>Marge (€)</th>
                <th>Marge (%)</th>
            </tr>
            {% endif %}
        </thead>

        <tbody>
            {% if grp == 'items' %}
            {% for r in rows %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                  <a href="{{ url_for('reports.report_customers') }}?artikel={{ r[1] | urlencode }}"
                     class="text-decoration-none">
                     {{ r[1] }}
                  </a>
                </td>
                <td class="text-end">{{ r[2] | thousands(0) }}</td>
                <td class="text-end">{{ r[3] | thousands(0) }}</td>
                <td class="text-end">{{ r[4] | thousands }}</td>
                <td class="text-end">{{ r[5] | thousands }}</td>
                <td class="text-end">{{ r[6] | thousands }}</td>
                <td class="text-end">{{ r[7] | thousands(2) }} %</td>
            </tr>
            {% endfor %}
            {% else %}
            {% for r in rows %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ r[0] }}</td>
                <td class="text-end">{{ r[1] | thousands(0) }}</td>
                <td class="text-end">{{ r[2] | thousands(0) }}</td>
                <td class="text-end">{{ r[3] | thousands }}</td>
                <td class="text-end">{{ r[4] | thousands }}</td>
                <td class="text-end">{{ r[5] | thousands }}</td>
                <td class="text-end">{{ r[6] | thousands(2) }} %</td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>

        <tfoot class="table-light fw-bold">
            <tr>
                <th colspan="2">Summe</th>
                <th class="text-end">{{ totals.positionen | thousands(0) }}</th>
                <th class="text-end">{{ totals.menge | thousands(0) }}</th>
                <th class="text-end">{{ totals.umsatz | thousands }}</th>
                <th class="text-end">{{ totals.kosten | thousands }}</th>
                <th class="text-end">{{ totals.marge  | thousands }}</th>
                <th class="text-end">
                    {% set marge_pct_total = (100.0 * totals.marge / (totals.umsatz if totals.umsatz != 0 else 1.0)) %}
                    {{ marge_pct_total | thousands(2) }} %
                </th>
            </tr>
        </tfoot>
    </table>
</div>


<script>
  const mode = "{{ grp }}";
  let labels, umsatz, margeEuro, margePct;

  {% if grp == 'items' %}
    labels    = {{ rows|map(attribute=1)|list|tojson }};
    umsatz    = {{ rows|map(attribute=4)|list|tojson }};
    margeEuro = {{ rows|map(attribute=6)|list|tojson }};
    margePct  = {{ rows|map(attribute=7)|list|tojson }};
  {% else %}
    labels    = {{ rows|map(attribute=0)|list|tojson }};
    umsatz    = {{ rows|map(attribute=3)|list|tojson }};
    margeEuro = {{ rows|map(attribute=5)|list|tojson }};
    margePct  = {{ rows|map(attribute=6)|list|tojson }};
  {% endif %}

  new Chart(document.getElementById('artChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { type:'bar',  label:'Umsatz (€)', data: umsatz,    yAxisID:'yEur', borderWidth:1 },
        { type:'bar',  label:'Marge (€)',  data: margeEuro, yAxisID:'yEur', borderWidth:1 },
        { type:'line', label:'Marge (%)',  data: margePct,  yAxisID:'yPct', borderWidth:2, fill:false, tension:.25, pointRadius:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{
        yEur:{ position:'left', beginAtZero:true, title:{display:true,text:'€'} },
        yPct:{ position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, title:{display:true,text:'%'} },
        x:{ ticks:{ autoSkip:(mode==='items'? false:true), maxRotation:45 } }
      },
      plugins:{ legend:{ display:true } }
    }
  });

  // Клавіші: Ctrl+Enter = фільтр, Escape = скинути
  document.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){ document.querySelector('form.filters').submit(); }
    if(e.key==='Escape'){ window.location="{{ url_for('reports.report_articles') }}"; }
  });
</script>

{% endblock %}
