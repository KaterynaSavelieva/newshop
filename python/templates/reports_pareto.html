{% extends "base.html" %}
{% block title %}Pareto 80/20{% endblock %}
{% block content %}

<h3 class="mb-3">Pareto 80/20</h3>

<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <label class="form-label" for="von">Von</label>
    <input id="von" type="date" name="von" class="form-control" value="{{ von }}">
  </div>

  <div class="col-auto">
    <label class="form-label" for="bis">Bis</label>
    <input id="bis" type="date" name="bis" class="form-control" value="{{ bis }}">
  </div>

  <div class="col-auto">
    <label class="form-label" for="by">Modus</label>
    <select id="by" name="by" class="form-select">
      <option value="artikel" {% if by =='artikel' %}selected{% endif %}>Artikel</option>
      <option value="kunde"   {% if by =='kunde'   %}selected{% endif %}>Kunde</option>
    </select>
  </div>

  <div class="col-auto align-self-end">
    <button class="btn btn-primary">Anzeigen</button>
  </div>
</form>

<div class="alert alert-info py-2">
  Gesamtumsatz: <b>{{ '%.2f'|format(total) }} â‚¬</b>.
  Top-80% erreichen <b>{{ top80_count }}</b>
  {{ 'Kunden' if by=='kunde' else 'Artikel' }}
  (<b>{{ '%.1f'|format(top80_pct) }}%</b>).
</div>

<div class="card mb-3">
  <div class="card-header py-2">Pareto-Diagramm (Balken = Umsatz, Linie = kum. %)</div>
  <div class="card-body">
    <div id="paretoContainer" style="position:relative; width:100%; height:460px;">
      <canvas id="paretoChart"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header py-2">Tabelle (nach Umsatz absteigend)</div>
  <div class="table-responsive">
    <table class="table table-sm table-striped table-bordered mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>{{ 'Kunde' if by=='kunde' else 'Artikel' }}</th>
          <th class="text-end">Umsatz (â‚¬)</th>
          <th class="text-end">Anteil (%)</th>
          <th class="text-end">Kumulativ (%)</th>
          <th>Top 80%</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.rank }}</td>
          <td>{{ r.name }}</td>
          <td class="text-end">{{ '%.2f'|format(r.umsatz) }}</td>
          <td class="text-end">{{ '%.2f'|format(r.share) }}</td>
          <td class="text-end">{{ '%.2f'|format(r.cum_share) }}</td>
          <td>
            {% if r.in80 %}
              <span class="badge bg-success">âœ“</span>
            {% else %}
              <span class="badge bg-secondary">â€“</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const labels  = {{ chart_labels   | tojson | safe }};
  const barsRaw = {{ chart_bars     | tojson | safe }};
  const cumRaw  = {{ chart_cum_line | tojson | safe }};

  const bars    = Array.isArray(barsRaw) ? barsRaw.map(v => Number(v) || 0) : [];
  const cumLine = Array.isArray(cumRaw)  ? cumRaw.map(v => Number(v) || 0)  : [];

  function buildPareto() {
    try {
      if (typeof Chart === 'undefined') {
        console.error('âŒ Chart.js not loaded');
        return;
      }

      const cvs = document.getElementById('paretoChart');
      if (!cvs) {
        console.error('âŒ Canvas #paretoChart not found');
        return;
      }

      // ðŸ§© Ð‘ÐµÐ·Ð¿ÐµÑ‡Ð½Ðµ Ð·Ð½Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½ÑŒÐ¾Ð³Ð¾ Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ°
      if (window.paretoChart && typeof window.paretoChart.destroy === 'function') {
        window.paretoChart.destroy();
      }

      // ðŸ§  ÐŸÐ¾Ð±ÑƒÐ´Ð¾Ð²Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ°
      const ctx = cvs.getContext('2d');
      window.paretoChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              type: 'bar',
              label: 'Umsatz (â‚¬)',
              data: bars,
              yAxisID: 'y',
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              type: 'line',
              label: 'Kumulativ (%)',
              data: cumLine,
              yAxisID: 'y1',
              tension: 0.3,
              pointRadius: 2,
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.3)',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y:  { title: { display: true, text: 'Umsatz (â‚¬)' }, beginAtZero: true },
            y1: { title: { display: true, text: 'Kumulativ (%)' }, min: 0, max: 100, position: 'right',
                  grid: { drawOnChartArea: false } },
            x:  {
              // Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð²ÑÑ– Ð¼Ñ–Ñ‚ÐºÐ¸ Ð¹ Ð¿Ð¾Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¸ Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾
              ticks: {
                autoSkip: false,
                minRotation: 90,
                maxRotation: 90,
                font: { size: 10 },
                // ÐºÐ¾Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð±ÐµÑ€ÐµÐ¼Ð¾ Ñ‚ÐµÐºÑÑ‚ Ð¼Ñ–Ñ‚ÐºÐ¸ Ð´Ð»Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ñ–Ð¹Ð½Ð¾Ñ— Ð¾ÑÑ–
                callback: function(value /* index */) {
                  const lab = this.getLabelForValue(value);
                  return lab;        // Ð°Ð±Ð¾ lab.replace(/\s+/g, '\n') â€” Ð±ÑƒÐ´Ðµ Ð±Ð°Ð³Ð°Ñ‚Ð¾Ñ€ÑÐ´ÐºÐ¾Ð²Ð¸Ð¹ Ð¿Ñ–Ð´Ð¿Ð¸Ñ
                }
              }
            }
          },
          plugins: { legend: { display: true } },
          // ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ Ð²ÑƒÐ¶Ñ‡Ñ– â€” Ð±Ñ–Ð»ÑŒÑˆÐµ Ð²Ð»Ð°Ð·Ð¸Ñ‚ÑŒ
          datasets: {
            bar: {
              categoryPercentage: 0.8,  // 0..1
              barPercentage: 0.9
            }
          }
        }
      });

      console.log('âœ… Pareto chart built successfully');
    } catch (e) {
      console.error('âŒ Error while building Pareto chart:', e);
    }
  }

  // â³ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ–ÑÐ»Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ¸
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', buildPareto);
  } else {
    buildPareto();
  }
  window.addEventListener('load', () => setTimeout(buildPareto, 100));
</script>

{% endblock %}
